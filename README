# Chatbot Backend - Cooperativa de Agua Potable

## ğŸ“‹ DescripciÃ³n

Sistema de chatbot inteligente con RAG (Retrieval-Augmented Generation) para la gestiÃ³n de emergencias y consultas en una Cooperativa de Agua Potable Rural.

## ğŸ¯ CaracterÃ­sticas

### MÃ³dulo de Emergencias âœ…
- âœ… **Chatbot Conversacional**: Entrevista guiada para reporte de emergencias
- âœ… **Sistema RAG**: Base de conocimiento con protocolos, sectores, contactos y FAQ
- âœ… **IntegraciÃ³n LLM**: Google Gemini para procesamiento de lenguaje natural
- âœ… **CÃ¡lculo AutomÃ¡tico de Prioridad**: 4 niveles (baja, media, alta, crÃ­tica)
- âœ… **API REST Completa**: Endpoints para chat, emergencias y estadÃ­sticas
- âœ… **Historial Persistente**: Almacenamiento de conversaciones y mensajes

### MÃ³dulo de Boletas ğŸ”œ
- En desarrollo

## ğŸ› ï¸ TecnologÃ­as

**Backend:**
- Django 5.2.8
- Django REST Framework 3.16.1
- Google Gemini (gemini-pro)
- ChromaDB 0.5.23
- LangChain 0.3.13
- Sentence Transformers

**Base de Datos:**
- SQLite (desarrollo)
- PostgreSQL (producciÃ³n)

## ğŸš€ Inicio RÃ¡pido

### 1. InstalaciÃ³n

```bash
# Clonar repositorio
git clone https://github.com/DaniBOD/Chatbot-Backend.git
cd Chatbot-Backend/Backend

# Crear entorno virtual
python -m venv venv
venv\Scripts\activate  # Windows

# Instalar dependencias
pip install -r requirements.txt
```

### 2. ConfiguraciÃ³n

```bash
# Configurar API key de Gemini en .env
GEMINI_API_KEY=tu_api_key_aqui
```

Obtener API key en: https://makersuite.google.com/app/apikey

### 3. Base de Datos

```bash
# Crear migraciones
python manage.py makemigrations
python manage.py migrate

# Crear superusuario
python manage.py createsuperuser
```

### 4. Ingestar Documentos RAG

```bash
python manage.py shell < ModuloEmergencia/RAG/ingest_documents.py
```

### 5. Iniciar Servidor

```bash
python manage.py runserver
```

Servidor: http://localhost:8000
Admin: http://localhost:8000/admin/

## ğŸ“– DocumentaciÃ³n

- **GuÃ­a RÃ¡pida**: [INICIO_RAPIDO.md](INICIO_RAPIDO.md)
- **DocumentaciÃ³n Completa**: [Doc/Documentacion-Emergencia.md](Doc/Documentacion-Emergencia.md)
- **Diagramas**: [Doc/](Doc/) (incluye diagramas de flujo y base de datos)

## ğŸŒ API Endpoints

### Chat
```
POST   /api/emergencias/chat/init/           - Iniciar conversaciÃ³n
POST   /api/emergencias/chat/message/        - Enviar mensaje
GET    /api/emergencias/chat/status/{id}/    - Ver estado
```

### Emergencias
```
GET    /api/emergencias/emergencias/         - Listar emergencias
GET    /api/emergencias/emergencias/{id}/    - Ver detalle
PATCH  /api/emergencias/emergencias/{id}/    - Actualizar
GET    /api/emergencias/emergencias/estadisticas/  - EstadÃ­sticas
```

### RAG
```
GET    /api/emergencias/rag/stats/           - EstadÃ­sticas del sistema
```

## ğŸ“ Estructura del Proyecto

```
Backend/
â”œâ”€â”€ chatbot_backend/          # ConfiguraciÃ³n Django
â”‚   â”œâ”€â”€ settings.py
â”‚   â””â”€â”€ urls.py
â”œâ”€â”€ ModuloEmergencia/         # MÃ³dulo de emergencias âœ…
â”‚   â”œâ”€â”€ models.py            # Emergencia, ChatConversation, ChatMessage
â”‚   â”œâ”€â”€ views.py             # API REST endpoints
â”‚   â”œâ”€â”€ serializers.py       # DRF serializers
â”‚   â”œâ”€â”€ admin.py             # Admin panel
â”‚   â”œâ”€â”€ services/            # LÃ³gica de negocio
â”‚   â”‚   â””â”€â”€ chatbot_service.py
â”‚   â””â”€â”€ RAG/                 # Sistema RAG
â”‚       â”œâ”€â”€ vector_store.py  # ChromaDB
â”‚       â”œâ”€â”€ embeddings.py    # Procesamiento de docs
â”‚       â”œâ”€â”€ retriever.py     # RecuperaciÃ³n de info
â”‚       â”œâ”€â”€ ingest_documents.py  # Script de ingesta
â”‚       â””â”€â”€ knowledge_base/  # Base de conocimiento
â”‚           â”œâ”€â”€ protocolos_emergencias.md
â”‚           â”œâ”€â”€ sectores_informacion.md
â”‚           â”œâ”€â”€ contactos_cooperativa.md
â”‚           â””â”€â”€ faq_preguntas_frecuentes.md
â”œâ”€â”€ ModuloBoletas/           # MÃ³dulo de boletas ğŸ”œ
â”œâ”€â”€ Doc/                     # DocumentaciÃ³n
â”‚   â””â”€â”€ Documentacion-Emergencia.md
â”œâ”€â”€ requirements.txt         # Dependencias Python
â”œâ”€â”€ .env.example            # Ejemplo de variables de entorno
â””â”€â”€ manage.py               # Django management
```

## ğŸ§ª Ejemplo de Uso

```python
import requests

# 1. Iniciar conversaciÃ³n
response = requests.post('http://localhost:8000/api/emergencias/chat/init/')
session_id = response.json()['session_id']

# 2. Reportar emergencia
response = requests.post('http://localhost:8000/api/emergencias/chat/message/', json={
    'session_id': session_id,
    'message': 'Tengo una fuga de agua muy grande en El Molino, calle Principal 123'
})

print(response.json()['message'])
# Bot: "Entiendo que tienes una fuga en El Molino. Â¿CuÃ¡l es tu nombre?"

# 3. Continuar conversaciÃ³n...
# El bot recolecta X1-X7, calcula prioridad y registra la emergencia
```

## ğŸ¯ Flujo del Chatbot

1. **Inicio**: Saludo y explicaciÃ³n
2. **RecolecciÃ³n**: Recopila 7 datos clave (sector, nombre, telÃ©fono, direcciÃ³n, etc.)
3. **AnÃ¡lisis**: Extrae informaciÃ³n usando Gemini + RAG
4. **Prioridad**: Calcula nivel automÃ¡ticamente (baja/media/alta/crÃ­tica)
5. **Contacto**: Ofrece datos de contacto colaborativo
6. **Registro**: Crea emergencia en base de datos

## ğŸ”‘ Datos Recolectados

- X1: Sector (7 sectores disponibles)
- X2: Datos del medidor/fuga
- X3: Fecha
- X4: Nombre del usuario
- X5: FotografÃ­a (opcional)
- X6: DirecciÃ³n
- X7: TelÃ©fono

## ğŸ“Š Niveles de Prioridad

- ğŸŸ¢ **BAJA**: Consultas generales, problemas menores
- ğŸŸ¡ **MEDIA**: Fugas moderadas, baja presiÃ³n localizada
- ğŸŸ  **ALTA**: Agua contaminada, caÃ±erÃ­a rota importante
- ğŸ”´ **CRÃTICA**: Rotura de matriz, sin agua en sector

## ğŸ‘¥ Sectores Atendidos

1. Anibana
2. El Molino
3. La CompaÃ±Ã­a
4. El MaitÃ©n 1
5. La Morera
6. El MaitÃ©n 2
7. Santa Margarita

## ğŸ“ Contactos de la Cooperativa

- **Emergencias**: +56 9 5403 8948 (24/7)
- **RecaudaciÃ³n**: +56 9 8149 4350
- **Gerencia**: +56 9 7846 7011
- **Correo**: laciacoop@gmail.com

## ğŸ”§ Desarrollo

### Ejecutar Tests
```bash
python manage.py test ModuloEmergencia
```

### Limpiar Base de Datos
```bash
python manage.py flush
```

### Reiniciar ChromaDB
```bash
# Eliminar carpeta chroma_db y volver a ingestar
rm -rf chroma_db
python manage.py shell < ModuloEmergencia/RAG/ingest_documents.py
```

## ğŸš¢ Despliegue

Ver [Documentacion-Emergencia.md](Doc/Documentacion-Emergencia.md) secciÃ³n "Despliegue" para:
- ConfiguraciÃ³n con PostgreSQL
- Docker & Docker Compose
- ConfiguraciÃ³n de producciÃ³n
- Consideraciones de seguridad

## ğŸ¤ Contribuir

1. Fork el proyecto
2. Crear rama feature (`git checkout -b feature/NuevaCaracteristica`)
3. Commit cambios (`git commit -m 'Agregar nueva caracterÃ­stica'`)
4. Push a la rama (`git push origin feature/NuevaCaracteristica`)
5. Abrir Pull Request

## ğŸ“ Notas

- Este proyecto fue desarrollado para la Cooperativa de Agua Potable Rural
- Fundada en 1968 con 58 aÃ±os de historia
- Sistema comunitario sin fines de lucro
- 20 km de red de agua potable

## ğŸ“„ Licencia

Proyecto desarrollado para fines educativos y comunitarios.

## ğŸ†˜ Soporte

- **Issues**: https://github.com/DaniBOD/Chatbot-Backend/issues
- **Email**: laciacoop@gmail.com
- **DocumentaciÃ³n**: [Doc/Documentacion-Emergencia.md](Doc/Documentacion-Emergencia.md)

---

**Ãšltima actualizaciÃ³n**: 5 de diciembre de 2025
**VersiÃ³n**: 1.0.0
**Estado**: âœ… MÃ³dulo de Emergencias - Completo | ğŸ”œ MÃ³dulo de Boletas - En desarrollo